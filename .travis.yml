language: php

services:
  - mysql

php:
  - 5.3
  - 5.4
  - 5.5
  - 5.6
  - 7.0
  - hhvm

matrix:
  fast_finish: true
  allow_failures:
    - php: 7.0
    - php: hhvm

before_script:
  # Composer
  - composer self-update
  - composer update
  - composer validate

  # Prepare database
  - mysql -e 'create database sqlbuilder;'

  # Install testing tools
  - composer require phpunit/phpunit:^4.8

  # Imstall phpcs ruleset.xml
  curl -sS https://raw.githubusercontent.com/JBZoo/Misc/master/phpcs/JBZoo/ruleset.xml > build/phpcs/ruleset.xml

  # Install report tools
  - sh -c 'if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then
        composer require
          satooshi/php-coveralls:dev-master
          squizlabs/php_codesniffer:*
          sebastian/phpcpd:*
          phploc/phploc:*
          phpmd/phpmd:^2.2
          pdepend/pdepend:^2.1
        ;
    fi;'

  # Dirs
  - mkdir -p build/cov
  - mkdir -p build/logs
  - mkdir -p build/phpunit
  - mkdir -p build/pdepend

  # Update env
  - phpenv rehash

script:
  # PHPUnit tests
  - php vendor/bin/phpunit --configuration phpunit.xml.dist;

after_script:
  # Send to coveralls
  - sh -c 'if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then
        php vendor/bin/coveralls --verbose;
    fi;'

  # Check PSR1,2 src and tests
  - sh -c 'if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then
        php vendor/bin/phpcs ./src --standard=build/phpcs/ruleset.xml --report=full;
    fi;'

  # Try to find copy-paste
  - sh -c 'if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then
        php vendor/bin/phpcpd ./src --no-interaction --verbose;
    fi;'

  # Show code statistic
  - sh -c 'if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then
        php vendor/bin/phploc ./src --no-interaction --verbose;
    fi;'

  # Show code problems
  - sh -c 'if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then
        php vendor/bin/phpmd ./src text cleancode     --verbose;
        php vendor/bin/phpmd ./src text codesize      --verbose;
        php vendor/bin/phpmd ./src text controversial --verbose;
        php vendor/bin/phpmd ./src text design        --verbose;
        php vendor/bin/phpmd ./src text naming        --verbose;
        php vendor/bin/phpmd ./src text unusedcode    --verbose;
    fi;'

  # Build pdepend stats
  - sh -c 'if [ "$TRAVIS_PHP_VERSION" = "5.6" ]; then
        php vendor/bin/pdepend
          --summary-xml=build/pdepend/summary.xml
          --jdepend-chart=build/pdepend/jdepend.svg
          --overview-pyramid=build/pdepend/pyramid.svg ./src;
    fi;'

notifications:
  email: github@jbzoo.com
